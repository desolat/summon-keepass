name: Create Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'What type of release to create'
        required: true
        type: choice
        options:
          - release (finalize pre-release or patch bump)
          - minor (new features)
          - major (breaking changes)
          - alpha (pre-release)
          - beta (pre-release)
          - rc (pre-release)
          - custom (specify exact version)
      custom_version:
        description: 'Custom version (only if "custom" is selected above)'
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Install cargo-release
      run: cargo install cargo-release

    - name: Determine release command
      id: release-cmd
      run: |
        RELEASE_TYPE="${{ github.event.inputs.release_type }}"
        CUSTOM_VERSION="${{ github.event.inputs.custom_version }}"

        # Extract the first word from the selection (e.g., "release (finalize...)" -> "release")
        RELEASE_CMD=$(echo "$RELEASE_TYPE" | awk '{print $1}')

        # Handle custom version
        if [ "$RELEASE_CMD" = "custom" ]; then
          if [ -z "$CUSTOM_VERSION" ]; then
            echo "Error: Custom version is required when 'custom' is selected"
            exit 1
          fi
          RELEASE_CMD="$CUSTOM_VERSION"
          echo "üì¶ Creating custom version: $CUSTOM_VERSION"
        # Handle pre-release levels (alpha, beta, rc)
        elif [[ "$RELEASE_CMD" =~ ^(alpha|beta|rc)$ ]]; then
          echo "üì¶ Creating pre-release: $RELEASE_CMD of current version"
        # Handle regular version bumps (release, minor, major)
        else
          # Map "release" to "patch" for cargo-release
          if [ "$RELEASE_CMD" = "release" ]; then
            RELEASE_CMD="patch"
          fi
          echo "üì¶ Creating release: $RELEASE_CMD bump"
        fi

        echo "command=$RELEASE_CMD" >> $GITHUB_OUTPUT
        echo "üì¶ Will execute: cargo release $RELEASE_CMD"

    - name: Dry-run release
      run: |
        echo "üîç Running dry-run first..."
        cargo release ${{ steps.release-cmd.outputs.command }} --dry-run --no-confirm

    - name: Execute release
      run: |
        echo "üöÄ Executing release..."
        cargo release ${{ steps.release-cmd.outputs.command }} --execute --no-confirm

    - name: Get version and package info
      id: get-version
      run: |
        VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
        PACKAGE_NAME=$(cargo metadata --no-deps | jq -r .packages[0].name)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
        echo "target_file=${PACKAGE_NAME}-linux-amd64.tar.gz" >> $GITHUB_OUTPUT
        echo "üìå Version: $VERSION"
        echo "üì¶ Package: $PACKAGE_NAME"

    - name: Build binary
      run: |
        echo "üî® Building release binary..."
        cargo build --verbose --release
        strip target/release/${{ steps.get-version.outputs.package_name }}
        mv target/release/${{ steps.get-version.outputs.package_name }} ${{ steps.get-version.outputs.package_name }}

    - name: Package binary
      uses: thedoctor0/zip-release@master
      with:
        filename: ${{ steps.get-version.outputs.target_file }}
        path: ${{ steps.get-version.outputs.package_name }}
        type: tar

    - name: Determine release type
      id: release-type
      run: |
        VERSION="${{ steps.get-version.outputs.version }}"
        # Check if version contains pre-release identifier (-, alpha, beta, rc)
        if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
          echo "üì¶ Creating stable release: v$VERSION"
        else
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
          echo "üì¶ Creating pre-release: v$VERSION"
        fi

    - name: Extract changelog
      id: changelog
      run: |
        VERSION="${{ steps.get-version.outputs.version }}"
        # Extract the section for this version from CHANGELOG.md
        awk "BEGIN{p=0} /^## \[${VERSION}\]/{p=1; next} /^## \[/ && p{exit} p" CHANGELOG.md > /tmp/changelog.txt
        # If empty, fall back to a default message
        if [ ! -s /tmp/changelog.txt ]; then
          echo "Release ${VERSION}" > /tmp/changelog.txt
        fi
        echo "changelog_file=/tmp/changelog.txt" >> $GITHUB_OUTPUT

    - name: Push changes
      run: |
        echo "‚¨ÜÔ∏è Pushing commit and tags..."
        git push --follow-tags

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get-version.outputs.version }}
        prerelease: ${{ steps.release-type.outputs.is_prerelease }}
        files: ${{ steps.get-version.outputs.target_file }}
        body_path: ${{ steps.changelog.outputs.changelog_file }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
