# Stage 1: Cache dependencies
FROM rust:1.85-bookworm AS dependencies
WORKDIR /build
COPY Cargo.toml ./
# Note: Cargo.lock is in .gitignore, so not copied. Cargo will generate it.
RUN mkdir src && echo "fn main() {}" > src/main.rs
RUN cargo build --release && rm -rf src

# Stage 2: Build application and tests
FROM rust:1.85-bookworm AS builder
WORKDIR /build
COPY --from=dependencies /build/target target
COPY . .
RUN cargo build --release
RUN cargo test --release --no-run

# Stage 3: Test runtime
FROM rust:1.85-bookworm
WORKDIR /app

RUN apt-get update && apt-get install -y \
    libssl3 ca-certificates \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /build/target/release/summon-keepass /usr/local/bin/
COPY --from=builder /build/target/release/deps /app/target/release/deps
COPY Cargo.toml ./
COPY src ./src
COPY tests ./tests

ENV HOME=/tmp/test-home
ENV RUST_BACKTRACE=1
RUN mkdir -p ${HOME}

CMD ["cargo", "test", "--release", "--", "--test-threads=1", "--nocapture"]
